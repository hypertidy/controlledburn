---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# controlledburn

<!-- badges: start -->
[![R-CMD-check](https://github.com/hypertidy/controlledburn/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/hypertidy/controlledburn/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

Rasterize polygons without materializing any pixel values. controlledburn
computes exact coverage fractions for polygon-grid intersections and returns
results as sparse tables: run-length encoded interior cells and individually
weighted boundary cells.

The scanline algorithm is O(perimeter) in both time and memory.

## Installation

```r
remotes::install_github("hypertidy/controlledburn")
```

## Usage

```{r usage}
library(controlledburn)
library(geos)

poly <- as_geos_geometry("POLYGON ((1 1, 9 1, 9 9, 1 9, 1 1))")

# Sparse output — no dense matrix allocated
r <- burn_scanline(poly, extent = c(0, 10, 0, 10), dimension = c(20L, 20L))
r
#> <controlledburn> 20 x 20 grid, 1 geometry
#>   runs:  N (interior cells)
#>   edges: N boundary cells

# Materialise only when you need it
mat <- materialise_chunk(r)
```

### Default grid parameters

With no extent or dimension, controlledburn derives both from the geometry:

```{r helpers}
r <- burn_scanline(poly)
# extent from wk::wk_bbox(), 256 cells on the long axis
```

Or specify resolution:

```{r resolution}
r <- burn_scanline(poly, resolution = 0.5)
```

### Geometry input

Accepts `geos_geometry`, `sfc`, `wk::wkb()`, `blob`, or raw WKB list
(compatible with vapour/gdalraster):

Note that `geos::as_geos_geometry()` provides interchange for `terra::vect()`. 

### Shared boundary complementarity

Adjacent polygons with shared edges produce complementary coverage fractions
that sum to exactly 1.0 in every boundary cell — no gaps, no overlaps:

```{r shared}
left  <- as_geos_geometry("POLYGON ((0 0, 5 0, 5 10, 0 10, 0 0))")
right <- as_geos_geometry("POLYGON ((5 0, 10 0, 10 10, 5 10, 5 0))")

r <- burn_scanline(c(left, right), extent = c(0,10,0,10), dimension = c(20L,20L))

# Coverage sums to 1.0 in every touched cell
mat1 <- materialise_chunk(r, id = 1)
mat2 <- materialise_chunk(r, id = 2)
max(mat1 + mat2)
#> [1] 1
```

## Output format

`burn_scanline()` and `burn_sparse()` return a list with class
`"controlledburn"` containing:

- **`runs`**: `data.frame(row, col_start, col_end, id)` — interior cells
  with coverage = 1.0, run-length encoded by row.
- **`edges`**: `data.frame(row, col, weight, id)` — boundary cells with
  exact partial coverage in (0, 1).
- **`extent`**: `c(xmin, xmax, ymin, ymax)`
- **`dimension`**: `c(ncol, nrow)`

This is the natural output of scanline rasterization — no dense matrix is
allocated until `materialise_chunk()` is called.

## Performance

Scanline algorithm scales with perimeter, not area:

| Shape | Resolution | Scanline | Dense (burn_sparse) | Speedup |
|-------|-----------|----------|-------------------|---------|
| Star | 3200×3200 | 13 ms | 225 ms | 17× |
| Jagged | 3200×3200 | 15 ms | 136 ms | 9× |
| NC counties | 2000×800 | 29 ms | 61 ms | 2× |

Memory for real-world grids (CGAZ at 32K×16K, ~500M cells): ~50 MB sparse
vs ~2 GB dense.

## Fast

```{r fast}
v <- new(gdalraster::GDALVector, "/vsicurl/https://github.com/mdsumner/geoboundaries/releases/download/latest/geoBoundariesCGAZ_ADM0.parquet")
v$returnGeomAs ## WKB
gcol <- v$getGeometryColumn()
v$setIgnoredFields( setdiff(v$getFieldNames(), gcol))
wkbgeom <- wk::wkb(v$fetch(-1)[[gcol]])
v$close()

system.time(burn_scanline(wkbgeom))

system.time(r1 <- burn_scanline(wkbgeom, dimension = c(8192, 4096)))
str(r1)
```

Really fast. 

```{r faast}
system.time(r1 <- burn_scanline(wkbgeom, dimension = c(8192, 4096) * 20))
pryr::object_size(r1)
tibble::as_tibble(r1$runs)
tibble::as_tibble(r1$edges)
r1[c("extent", "dimension")]
```


## History

controlledburn was derived from [fasterize](https://github.com/ecohealthalliance/fasterize)
by Noam Ross (EcoHealth Alliance), removing Armadillo and raster package
dependencies to return bare scanline indexes.

Version 0.1.0 is a complete rewrite using the exactextract algorithm
(Daniel Baston, vendored from [exactextractr](https://github.com/isciences/exactextractr))
for exact coverage fractions via a new O(perimeter) scanline sweep.

See also: [vaster](https://github.com/hypertidy/vaster) for grid
cell indexing, [exactextractr](https://github.com/isciences/exactextractr)
for raster extraction with polygon weights.

## Code of Conduct

Please note that the controlledburn project is released with a
[Contributor Code of Conduct](https://contributor-covenant.org/version/2/1/CODE_OF_CONDUCT.html).
By contributing to this project, you agree to abide by its terms.
